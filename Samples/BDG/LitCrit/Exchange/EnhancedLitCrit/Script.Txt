Option Explicit
Const LAYOUTFLAG_VERTICAL_ONLY = 65
Const LAYOUTFLAG_VERTICAL_AND_HORIZONTAL = 68
Const MAPI_PROPTAG_SERVERNAME = 1715732510 'PropID For Server Name

Dim Critique_Status
Dim CurrentUser

On Error Resume Next

Function Item_Open()
Dim MyPage,MyInspector

  Set MyInspector = Item.GetInspector
  CurrentUser =   Application.GetNameSpace("MAPI").CurrentUser
  'Check who is opening item and use appropriate Compose/Read Page combination
  If Item.UserProperties("OldUserName")= CurrentUser AND UserProperties("bibNo") <> 0 Then
  	MyInspector.ShowFormPage("HalfRead")
	MyInspector.HideFormPage("Others")
      MyInspector.HideFormPage("CurrentUser")
      MyInspector.SetCurrentFormPage("HalfRead")
      Set MyPage= MyInspector.ModifiedFormPages("HalfRead")
  ElseIf UserProperties("OldUserName")=CurrentUser AND UserProperties("bibNo") = 0 Then
      MyInspector.ShowFormPage("CurrentUser")
      MyInspector.HideFormPage("Others")
      MyInspector.HideFormPage("HalfRead")
      MyInspector.SetCurrentFormPage("CurrentUser")
      Set MyPage = MyInspector.ModifiedFormPages("CurrentUser")
  Else
      MyInspector.ShowFormPage("Others")
      MyInspector.HideFormPage("CurrentUser")
      MyInspector.HideFormPage("HalfRead")
      MyInspector.SetCurrentFormPage("Others")
      Set MyPage = MyInspector.ModifiedFormPages("Others")
  End If

' Show this box only for the for first time
 If UserProperties("Item Title") = "" Then
    Dim BibNo,Title,Authors,MediaType,CritiqueNo
    Dim Response,ObjCritique, LogOn, ServerName
    Dim objSession,MyFields,element,MyAddressLists,MyEntries,MyEntry,MyName
    Dim objCDOSession,objFolder,Field
  
    'Instantiating CDO Session 
    Set objCDOSession = Application.CreateObject("MAPI.Session")
        objCDOSession.LogOn "",False,False,False 'ProfileName,ProfilePassword,ShowDialog,OldSession
        Set objFolder =  objCDOSession.Inbox
        For Each Field in objFolder.Fields
            If Field.ID = MAPI_PROPTAG_SERVERNAME  Then 
               ServerName = Field.Value
            End If
        Next
   
    Set objSession = Application.GetNameSpace("MAPI")
    Set MyAddressLists = objSession.AddressLists("Global Address List")
    Set MyEntries = MyAddressLists.AddressEntries
    Set MyEntry = MyEntries.Item(CurrentUser)
   
    LogOn = MyEntry.Address

    Set ObjCritique = Application.Createobject("LitCritC.Critique")
      objCritique.ChooseTitle BibNo, Title, Authors,MediaType, CritiqueNo,CStr(LogOn) ,CStr(ServerName)
  	If BibNo <> "" Then
         MyInspector.ShowFormPage("HalfRead")
	   MyInspector.HideFormPage("Others")
         MyInspector.HideFormPage("CurrentUser")
         MyInspector.SetCurrentFormPage("HalfRead")
         Set MyPage= MyInspector.ModifiedFormPages("HalfRead") 
         UserProperties("OldUserName")= CurrentUser
         Item.UserProperties("Media").Value = MediaType
      End If
      Item.UserProperties("Item Title").Value  = Title
      Item.UserProperties("AuthName").Value = Authors
      Item.UserProperties("bibNo").Value = BibNo
      Item.UserProperties("CritiqueNo").Value = CritiqueNo
      
      Item.UserProperties("ApprovalRequired") = CBool(objCritique.GetApplicationSetting("ApprovalRequired",CStr(ServerName)))
      If UserProperties("ApprovalRequired") =  True Then
         UserProperties("ApproverEmail")= objCritique.GetApplicationSetting("ApproverEmail",CStr(ServerName))
         UserProperties("isApproved") =  False
      Else 
         UserProperties("isApproved") = True 
      End If

 End if

  'Choose the default option of radio button to load image
  Select Case Item.UserProperties("Media").Value 
     Case "Book"
	set MyPage.imgMedia.Picture = MyPage.ImageList1.ListImages("Book").Picture
     Case "Audio/Video"
	set MyPage.imgMedia.Picture = MyPage.ImageList1.ListImages("AV").Picture
     Case "Periodicals"
	set MyPage.imgMedia.Picture = MyPage.ImageList1.ListImages("Prd").Picture
     Case "Software"
	set MyPage.imgMedia.Picture = MyPage.ImageList1.ListImages("Soft").Picture
  End Select

  'To Resize the Message Control Vertically
  MyPage.frmMessage.LayoutFlags=LAYOUTFLAG_VERTICAL_AND_HORIZONTAL
  MyPage.frmMessage.txtMessage.LayoutFlags=LAYOUTFLAG_VERTICAL_AND_HORIZONTAL 

End Function

'This event is fired when value of custom property changes
Sub Item_CustomPropertyChange(ByVal Name)
Dim MyPage,MyInspector

   Set MyInspector = Item.GetInspector

  'Check who is opening item and use appropriate Compose/Read Page combination
  'BiBNo indicates that Item is connected to CML and therefore it should be protected 
  'from editing its title , author and Media type information
  If Item.UserProperties("OldUserName")= CurrentUser AND UserProperties("bibNo") <> 0 Then
  	MyInspector.ShowFormPage("HalfRead")
	MyInspector.HideFormPage("Others")
      MyInspector.HideFormPage("CurrentUser")
      MyInspector.SetCurrentFormPage("HalfRead")
      Set MyPage= MyInspector.ModifiedFormPages("HalfRead")
  ElseIf UserProperties("OldUserName") = CurrentUser AND UserProperties("bibNo") = 0 Then 
      MyInspector.ShowFormPage("CurrentUser")
      MyInspector.HideFormPage("Others")
      MyInspector.HideFormPage("HalfRead")
      MyInspector.SetCurrentFormPage("CurrentUser")
      Set MyPage = MyInspector.ModifiedFormPages("CurrentUser")
  Else 
      MyInspector.ShowFormPage("Others")
      MyInspector.HideFormPage("CurrentUser")
      MyInspector.HideFormPage("HalfRead")
      MyInspector.SetCurrentFormPage("Others")
      Set MyPage = MyInspector.ModifiedFormPages("Others")
  End If

  Select Case Name
     Case "Item Title"
	    If Not Critique_Status  And Len(UserProperties("Item Title"))> 0 Then
  	       UserProperties("Subject")="Critique of: " & UserProperties("Item Title")
	    End If
   
     Case "Media"
 	  Select Case Item.UserProperties("Media").Value 
     	    Case "Book"
	  	Set MyPage.imgMedia.Picture = MyPage.ImageList1.ListImages("Book").Picture
          Case "Audio/Video"
            Set MyPage.imgMedia.Picture = MyPage.ImageList1.ListImages("AV").Picture
          Case "Periodicals"
            Set MyPage.imgMedia.Picture = MyPage.ImageList1.ListImages("Prd").Picture
          Case "Software"
            Set MyPage.imgMedia.Picture = MyPage.ImageList1.ListImages("Soft").Picture

          End Select
   End Select
End Sub

'This event is fired when the standard property like subject,from,to is changed
Sub Item_PropertyChange(ByVal Name)
	Dim TempString
 	Select Case Name
  	  Case "Subject"
	    TempString = "Critique of: " & Item.UserProperties("Item Title").Value
	    If TempString <> UserProperties("Subject").Value then 
	    	Critique_Status = True
	    End If
	  Case Else
      End Select
End Sub

'Event is called when User hits the post button 
Function Item_Write()

Dim MyPage,MyInspector

  Set MyInspector = Item.GetInspector
 'Check who is opening item and use appropriate Compose/Read Page combination

 If Item.UserProperties("OldUserName")= CurrentUser AND UserProperties("bibNo") <> 0 Then
    MyInspector.ShowFormPage("HalfRead")
    MyInspector.HideFormPage("Others")
    MyInspector.HideFormPage("CurrentUser")
    MyInspector.SetCurrentFormPage("HalfRead")
    Set MyPage= MyInspector.ModifiedFormPages("HalfRead")
 ElseIf UserProperties("OldUserName") = CurrentUser AND UserProperties("bibNo") = 0 Then 
    MyInspector.ShowFormPage("CurrentUser")
    MyInspector.HideFormPage("Others")
    MyInspector.HideFormPage("HalfRead")
    MyInspector.SetCurrentFormPage("CurrentUser")
    Set MyPage = MyInspector.ModifiedFormPages("CurrentUser")
 Else 
    MyInspector.ShowFormPage("Others")
    MyInspector.HideFormPage("CurrentUser")
    MyInspector.HideFormPage("HalfRead")
    MyInspector.SetCurrentFormPage("Others")
    Set MyPage = MyInspector.ModifiedFormPages("Others")
 End If

 If UserProperties("AuthName")= "<Last,First>"  or UserProperties("AuthName")="" Then
    UserProperties("AuthName")="Not Mentioned"
 End If
 If UserProperties("Tech Level")= "<Select Rating>" Then
    UserProperties("Tech Level")="Not Rated"
 End If
 If UserProperties("Job Relevance")="<Select Rating>" Then
    UserProperties("Job Relevance") ="Not Rated"
 End If
 If UserProperties("Clarity Rating")="<Select Rating>" Then
    UserProperties("Clarity Rating") = "Not Rated"
 End If 
	
 'To attach the text to body property of postItem
 Item.HTMLbody = "<i> " & Item.UserProperties("CritiqueText").Value & "</i>"
	
 Select Case Item.UserProperties("Media").Value
     Case "Book"
	    Set MyPage.imgMedia.Picture = MyPage.ImageList1.ListImages("Book").Picture
     Case "Audio/Video"
	    Set MyPage.imgMedia.Picture = MyPage.ImageList1.ListImages("AV").Picture
     Case "Periodicals"
	    Set MyPage.imgMedia.Picture = MyPage.ImageList1.ListImages("Prd").Picture
     Case "Software"
	    Set MyPage.imgMedia.Picture = MyPage.ImageList1.ListImages("Soft").Picture
 End Select

 'Concatenating the strings into one field 
 UserProperties("LongAuthor") = "by " & UserProperties("AuthName")
 UserProperties("LongMedia") = UserProperties("Media") & " reviewed by "  & CurrentUser & " on " & Now()
End Function

    
    
    
    
  
  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           